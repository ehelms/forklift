@startuml

note as general
  This diagram outlines the design of all components and
  their interactions within the OpenShift/Kubernetes environment.
  Squares represent pods with a single container running per pod
  (thus, any square can be scaled independently).
  The contents of each pod represent the service running inside the pod.
  Cylinders represent volume mounts that are shared amongst pods.
end note

/' Routes'/
interface "Foreman Route" as foreman_route

/' Pods '/
node "Postgres" {
  [postgres] as postgres
}

node "Foreman + Katello + Plugins" {
  [puma] as foreman
}

node "Dynflow" {
  [dynflowd] as dynflowd
}

node "Candlepin" {
  [tomcat] as candlepin
}

node "MongoDB" {
  [mongodb] as mongodb
}

node "Pulp API Server" {
  [httpd] as pulp
}

node "Pulp Worker" {
  [celery] as pulp_worker
}

node "Pulp Celery Beat" {
  [celery] as pulp_celery_beat
}

node "Pulp Resource Manager" {
  [celery] as pulp_resource_manager
}

node "Pulp Streamer" {
  [pulp_streamer] as pulp_streamer
}

node "Squid" {
  [squid] as squid
}

node "Qpid" {
  [qpidd] as qpid
}

node "Foreman Proxy" {
  [foreman-proxy] as foreman_proxy
}

node "Puppet Server" {
  [puppetserver] as puppet_server
}

node "Content Server" {
  [httpd] as content_server
}

node "Memcache" {
  [memcache] as memcache
}

/' Volumes '/
database "Pulp Data Volume" {
  folder "Content" {
    [/var/lib/pulp] as pulp_content
  }
}

database "Puppet Data Volume" {
  folder "Puppet environments" {
    [/etc/puppetlabs/code/environments] as puppet_environments
  }
}

database "Postgres Data Volume" {
  folder "Postgres Database" {
    [Postgres Datastore] as postgres_datastore
  }
}

database "MongoDB Data Volume" {
  folder "MongoDB Database" {
    [MongoDB Datastore] as mongodb_datastore
  }
}

/' Route Connections '/
foreman_route --> foreman : http:8080/
foreman_route --> content_server : http:80/pulp
foreman_route --> content_server : http:443/pulp
foreman_route --> puppet_server : http:8140/
foreman_route --> foreman_proxy : http:9090/

/' Service Connections '/
pulp --> mongodb : 27017
pulp_worker --> mongodb : 27017

pulp_worker --> qpid : 5672
pulp_resource_manager --> qpid : 5672
pulp_celery_beat --> qpid : 5672

pulp_streamer --> mongodb : 27017
squid --> pulp_streamer : 8751
content_server --> squid : 3128

candlepin --> postgres : 5432
candlepin --> qpid : 5672

foreman --> postgres : 5432
dynflowd --> postgres : 5432
foreman --> pulp : 443
foreman --> candlepin : 8443
foreman --> qpid : 5672
foreman --> memcache : 11211

foreman_proxy --> puppet_server : 8140
foreman_proxy --> foreman : 8080
foreman --> foreman_proxy : 9090

/' Data Connection '/
postgres --> postgres_datastore
mongodb --> mongodb_datastore

pulp_worker --> pulp_content
pulp_worker --> puppet_environments

content_server --> pulp_content
puppet_server --> puppet_environments

@enduml
